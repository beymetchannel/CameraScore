<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<link rel="manifest" href="manifest.json">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<link rel="shortcuticon" type="image/x-icon" href="CameraIcon.png">
<link rel="apple-touch-icon" sizes="180x180" href="CameraIcon.png">
<link rel="icon" href="CameraIcon.png">
<meta name="theme-color" content="#00D4FF">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CameraScore">
<title>CameraScore</title>
<style>
@font-face {
  font-family: 'CyberFont';
  src: url('CyberFont.ttf') format('truetype');
}
@font-face {
  font-family: 'DS-DIGIB';
  src: url('DS-DIGIB.ttf') format('truetype');
}
@font-face {
  font-family: 'EvogriaItalic';
  src: url('Evogria-Italic.otf') format('opentype');
}

body,html { margin:0;padding:0;height:100%;background:black;font-family:'CyberFont',sans-serif; }
video#camera { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; z-index:0; }
.bi-border{position:absolute;inset:0;pointer-events:none;background:url('bi.png')center/contain no-repeat;opacity:.6;filter:drop-shadow(0 0 20px #0ff);animation:glow 2s infinite alternate;z-index:1;}
@keyframes glow{0%{filter:drop-shadow(0 0 10px #0ff)}50%{filter:drop-shadow(0 0 25px #0ff)}100%{filter:drop-shadow(0 0 10px #0ff)}}

.ui-layer{position:absolute;inset:0;z-index:2;}

select,select option {font-family:'CyberFont'!important;letter-spacing:1px;}
.left-block select,.right-block select {
  font-size:1.3rem;width:40vw;max-width:400px;min-width:120px;
  padding:10px 12px;margin-bottom:10px;background:rgba(0,0,0,.6);
  color:#fff;border-radius:8px;border:2px solid;appearance:none;cursor:pointer;
}
.left-block select{border-color:#aaffff;}
.right-block select{border-color:#ffaaaa;text-align-last:right;}

.left-block select option,.right-block select option{font-size:1.3rem;}

.left-block,.right-block{
  position:absolute;top:20px;display:flex;flex-direction:column;pointer-events:auto;
}
.left-block{left:20px;}
.right-block{right:20px;align-items:flex-end;}

.frame-container{display:flex;flex-direction:column;gap:0;}

.frame{
  width:60px;
  height:10vh;
  border:2px solid;
  position:relative;
  overflow: hidden;
  pointer-events:auto;
  background:rgba(0,0,0,.7);
  backdrop-filter:blur(4px);
  /* box-shadow:0 0 15px,inset 0 0 30px; */
}

.frame.blue{
  border-color:#aaffff;
  /* box-shadow:0 0 15px #aaffff,inset 0 0 30px #aaffff; */
}
.frame.pink{
  border-color:#ffaaaa;
  /* box-shadow:0 0 15px #ffaaaa,inset 0 0 30px #ffaaaa; */
 }

.hud-ring{
position:absolute;
top:50%;
left:50%;
width:70px;
height:70px;
transform:translate(-50%,-50%);
animation:hudSpin 3s linear infinite;
pointer-events:none;
}
@keyframes hudSpin{from{transform:translate(-50%,-50%) rotate(0)}to{transform:translate(-50%,-50%) rotate(360deg)}}

.score{font-family:'DS-DIGIB'!important;font-size:25vh;color:#ffdd99;text-shadow:0 0 10px #ffaa33,0 0 20px #ffaa33,0 0 40px #ff4400;pointer-events:auto;}
.score-container{display:flex;align-items:center;gap:.8vw;}

.left-score-container .blader-name{border:2px solid #aaffff;}
.right-score-container .blader-name{border:2px solid #ffaaaa;}

.blader-name{
  padding:8px 12px;background:rgba(0,0,0,.6);color:#fff;border-radius:8px;
  font-size:1.6rem;cursor:text;white-space:nowrap;
}

.center-block{position:absolute;top:10px;left:50%;transform:translateX(-50%);text-align:center;z-index:3;}
.center-battle{font-size:1rem;color:#fff;}
.center-rank{font-size:2rem;color:#fff;border-bottom:2px solid #fff;cursor:pointer;user-select:none;}

.win-overlay{
  position:fixed;
  inset:0;
  display:flex;
  justify-content:center;
  align-items:center;
  text-align:center;
  color:#ffea50;
  font-size:8vw;
  white-space:pre-line;
  text-shadow:0 0 10px #fff59e,0 0 20px #ffea50,0 0 40px #ffdd33;z-index:1000;
  animation:winFlash 5s forwards;
}
@keyframes 
winFlash{
0%{transform:scale(.5);
opacity:0}10%{transform:scale(1.5);
opacity:1}100%{transform:scale(1);
opacity:0}}



.modal-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  backdrop-filter:blur(6px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:2000;
}
.modal-content{
  background:#0B0E1A;
  border:2px solid #00D4FF;
  width:90%;
  max-width:420px;
  padding:20px;
  border-radius:12px;
  color:#fff;
}
.modal-content.right{border-color:#FF33D4;}
.modal-content h2{text-align:center;margin-bottom:10px;}

.deck-input
{width:100%;
padding:12px;
margin-bottom:10px;
font-size:1.3rem;
font-family:'CyberFont',sans-serif;
background:rgba(0,0,0,.6);
border:2px solid #00eaff;
color:#fff;
box-sizing: border-box;
}

.modal-save-btn{
width:100%;
padding:12px;
margin-top:12px;
font-size:1.3rem;
font-family:'CyberFont',sans-serif;
background:rgba(0, 212, 255, 0.6);
font-weight:bold;
border-radius:6px;
cursor:pointer;
color: #000 !important;
}

.modal-save-btn.right{
background:rgba(255, 51, 212, 0.6);
color: #000 !important;
}

.deck-input.right {
  border-color: #FF33D4 !important;
}

.hud-ring.cyber-effect {
  animation: hudGlitch 1s infinite alternate, hudSpin 3s linear infinite;
}

@keyframes hudGlitch {
  0% { filter: drop-shadow(0 0 10px #0ff); opacity: 0.7; }
  25% { filter: drop-shadow(0 0 25px #0ff); opacity: 1; }
  50% { filter: drop-shadow(0 0 15px #0ff); opacity: 0.8; }
  75% { filter: drop-shadow(0 0 30px #0ff); opacity: 1; }
  100% { filter: drop-shadow(0 0 20px #0ff); opacity: 0.7; }
}

.hud-ring.right.cyber-effect {
  animation: hudGlitchPink 1s infinite alternate, hudSpin 3s linear infinite;
}

@keyframes hudGlitchPink {
  0% { filter: drop-shadow(0 0 10px #ff77ff); opacity: 0.7; }
  25% { filter: drop-shadow(0 0 25px #ff77ff); opacity: 1; }
  50% { filter: drop-shadow(0 0 15px #ff77ff); opacity: 0.8; }
  75% { filter: drop-shadow(0 0 30px #ff77ff); opacity: 1; }
  100% { filter: drop-shadow(0 0 20px #ff77ff); opacity: 0.7; }
}

@media screen and (orientation: landscape) {
  .left-block,
  .right-block {
    top: 2vh;    
    bottom: 2vh;    
    height: auto;
    display: flex;
    flex-direction: column;
    justify-content: space-between; 
  }

  .frame-container {
    flex-grow: 1;       
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .frame {
    height: auto;     
    flex: 1;          
    margin: 0; 
  }

  .score-container {
    margin-top: 1vh;
  }
}

/* サイドグロー */
.side-glow {
  position: fixed; 
  top: 0;
  bottom: 0;
  width: 20vw;
  pointer-events: none;
}


.side-glow::before {
  content: "";
  position: absolute;
  top: 0;
  bottom: 0;
  width: 100%;
  pointer-events: none;

  background: linear-gradient(
    to right,
    rgba(255, 230, 50, 0.9),
    rgba(255, 230, 50, 0.2),
    rgba(255, 230, 50, 0)
  );

  filter: blur(50px); 
  opacity: 0;
  animation: glowPulse 2s infinite ease-in-out;
  animation-play-state: paused;
}

.side-glow.active::before {
  opacity: 1 !important;
  animation-play-state: running; 
}

#leftArea { left:0; }
#rightArea { right:-100px; }


.side-glow.stop::before {
  opacity: 0 !important;
  animation: none !important;
  filter: none !important;
}


@keyframes glowPulse {
  0%   { opacity: 0; transform: scaleX(0.5) }
  50%  { opacity: 0.5; transform: scaleX(2) }
  100% { opacity: 0; transform: scaleX(0.5) }
}

.score.pulse {
  animation: scoreGlowWave 2.2s ease-in-out infinite;
}

@keyframes scoreGlowWave {
  0% {
    text-shadow:
      0 0 6px #ffaa33,
      0 0 14px #ffaa33,
      0 0 24px #ff4400;
    filter: brightness(1);
  }
  50% {
    text-shadow:
      0 0 10px #ffaa33,
      0 0 30px #ffaa33,
      0 0 45px #ff3300;
    filter: brightness(1.3);
  }
  100% {
    text-shadow:
      0 0 6px #ffaa33,
      0 0 14px #ffaa33,
      0 0 24px #ff4400;
    filter: brightness(1);
  }
}

.outline {
  stroke: cyan;
  stroke-width: 2px;
  stroke-dasharray: 1000;
  stroke-dashoffset: 1000;
  animation: draw 1s ease forwards;
  filter: drop-shadow(0 0 10px cyan) drop-shadow(0 0 22px cyan);
}

.fill {
  fill: white;
  opacity: 0;
  animation: appear 1s ease forwards 1s,
             rgbGlitch 1.5s infinite 0.5s;
}

@keyframes draw {
  0% { stroke-dashoffset: 1000; opacity: .2; }
  80% { opacity: 1; }
  100% { stroke-dashoffset: 0; opacity: 1; }
}

@keyframes appear {
  0%   { opacity: 0; filter: brightness(4) blur(4px); }
  60%  { opacity: 1; filter: brightness(2) blur(1px); }
  100% { opacity: 1; filter: brightness(1) blur(0); }
}

@keyframes rgbGlitch {
  0%, 100% { text-shadow: none; filter: none; }
  8%   { text-shadow: -2px 0 red, 2px 0 cyan; filter: brightness(1.5); }
  15%  { text-shadow: -4px 0 magenta, 4px 0 lime; filter: brightness(2.2) contrast(1.8); }
  25%  { text-shadow: -6px 0 cyan, 6px 0 red; filter: brightness(1.8) contrast(2); }
  38%  { text-shadow: -3px 0 lime, 3px 0 magenta; filter: brightness(2.5); }
  52%  { text-shadow: -1px 0 red, 1px 0 cyan; filter: brightness(1.6); }
  75%  { text-shadow: -5px 0 cyan, 5px 0 magenta; filter: brightness(2.3) blur(0.5px); }
}

@keyframes reverseDraw {
  0% { stroke-dashoffset: 0; opacity: 1; }
  100% { stroke-dashoffset: 1000; opacity: 0; filter: brightness(0) blur(6px); }
}

@keyframes fadeOut {
  0% { opacity: 1; }
  100% { opacity: 0; filter: brightness(0) blur(6px); }
}

.big { font-size: 150px; }
.small { font-size: 50px; }


</style>
</head>
<body>

<video id="camera" autoplay playsinline muted></video>
<div class="bi-border"></div>
<div id="leftArea" class="side-glow"></div>
<div id="rightArea" class="side-glow"></div>
<div class="ui-layer">
  
  <!-- LEFT -->
  <div class="left-block">
    <select class="blade-select" data-side="left"></select>
    <div class="frame-container left-frames">
      <div class="frame blue"></div><div class="frame blue"></div><div class="frame blue"></div><div class="frame blue"></div>
    </div>
    <div class="score-container left-score-container">
      <div class="score pulse" id="score-left">0</div>
      <div class="blader-name" id="left-blader" contenteditable>BLADER A</div>
    </div>
  </div>

  <!-- CENTER -->
  <div class="center-block">
    <div class="center-battle">Battle</div>
    <div class="center-rank" id="center-rank">1st</div>
  </div>

  <!-- RIGHT -->
  <div class="right-block">
    <select class="blade-select" data-side="right"></select>
    <div class="frame-container right-frames">
      <div class="frame pink"></div><div class="frame pink"></div><div class="frame pink"></div><div class="frame pink"></div>
    </div>
    <div class="score-container right-score-container">
      <div class="blader-name" id="right-blader" contenteditable>BLADER B</div>
      <div class="score pulse" id="score-right">0</div>
    </div>
  </div>
</div>

<!-- Deck Modal -->
<div id="deckModal" class="modal-overlay">
  <div id="deckModalContent" class="modal-content">
    <h2>Deck Edit</h2>
    <input class="deck-input" id="deck1">
    <input class="deck-input" id="deck2">
    <input class="deck-input" id="deck3">
    <button id="saveDeckBtn" class="modal-save-btn">Save</button>
  </div>
</div>

<script>

navigator.mediaDevices.getUserMedia({
  video: { facingMode: "environment" },
  audio: true
})
.then(stream => {
  const video = document.getElementById("camera");
  video.srcObject = stream;
})
.catch(err => console.error("カメラ起動失敗:", err));

let lastScores = { left: 0, right: 0 };
let scoreTimer = null;

let leftDeck = ["BayBlade A","BayBlade B","BayBlade C"];
let rightDeck = ["BayBlade A","BayBlade B","BayBlade C"];
let scoreChangePending = false;

function setSelectOptions(select){
  select.innerHTML = "";
  const deck = select.dataset.side === "left" ? leftDeck : rightDeck;

  deck.forEach(v=>{
    const o=document.createElement("option");
    o.textContent=v;
    select.appendChild(o);
  });

  select.append(new Option("-"), new Option("デッキ編集"));
  select.value = "-";
}

document.querySelectorAll(".blade-select").forEach(setSelectOptions);

const deckModal=document.getElementById("deckModal");
let currentSelect=null;

document.querySelectorAll(".blade-select").forEach(sel=>{
  sel.addEventListener("change",e=>{
    const v=e.target.value;
    

    if(scoreChangePending && v !== "デッキ編集" && v !== "-"){
      scoreChangePending = false;
      r = (r + 1) % ranks.length;
      centerRank.textContent = ranks[r];
    }
    
    if(v === "デッキ編集"){
      currentSelect = e.target;
      deckModal.style.display = "flex";

      const modal = document.getElementById("deckModalContent");
      const saveBtn = document.getElementById("saveDeckBtn");
      const borderColor = window.getComputedStyle(currentSelect).borderColor;
      modal.style.borderColor = borderColor;
      saveBtn.style.borderColor = borderColor;
      saveBtn.style.color = "#ffffff"; 
      saveBtn.style.backgroundColor = borderColor; 
      const inputs = [deck1, deck2, deck3];
      inputs.forEach((inp,i)=>{
        inp.value = currentSelect.options[i]?.text || "";
        inp.style.borderColor = borderColor;
      });
    }
    if(v==="-"){
      e.target.selectedIndex=0;
    }
  });
});

saveDeckBtn.onclick = () => {
  const deckValues = [deck1.value.trim(), deck2.value.trim(), deck3.value.trim()];
  if(deckValues.some(v => v === "")) {
    alert("未入力があります");
    return; 
  }

  if(currentSelect.dataset.side === "left"){
    leftDeck = deckValues;
  } else {
    rightDeck = deckValues;
  }

  document.querySelectorAll(".blade-select").forEach(setSelectOptions);
  currentSelect.value = "-";
  deckModal.style.display = "none";
  resetBattleState();
};



function resetBattleState() {
  
  document.getElementById("score-left").textContent = "0";
  document.getElementById("score-right").textContent = "0";
  lastScores.left = 0;s
  lastScores.right = 0;
  document.querySelectorAll(".hud-ring").forEach(h => h.remove());

  r = 0;
  centerRank.textContent = ranks[r];
  
}

function updateScore(container){
  const scoreEl = container.querySelector(".score");
  const count = container.querySelectorAll(".hud-ring").length;

  const leftScore = parseInt(document.getElementById("score-left").textContent);
  const rightScore = parseInt(document.getElementById("score-right").textContent);

  if(leftScore != lastScores.left || rightScore != lastScores.right){
    lastScores.left = leftScore;
    lastScores.right = rightScore;
    checkScoreForRank(container);
  }

  if(scoreEl.textContent != count){ 
    scoreEl.textContent = count;
    scoreEl.style.transform = "scale(5)";
    scoreEl.style.transition = "transform 0.5s";
    setTimeout(() => {
      scoreEl.style.transform = "scale(1)";
    }, 80);
  }

  checkScoreForRank();

  const nameEl = container.querySelector(".blader-name");
  const selectEl = container.querySelector(".blade-select");
  const leftArea = document.getElementById("leftArea");
  const rightArea = document.getElementById("rightArea");

  if(count === 4){
    const name = nameEl ? nameEl.textContent : "";
    scoreEl.classList.add("pulse");

    document.querySelectorAll(".win-overlay").forEach(d => d.remove());

    const div = document.createElement("div");
    div.className = "win-overlay";

    let winnerText = "";
    const trimmedName = name.trim();
    const selText = (selectEl && selectEl.options[selectEl.selectedIndex]) 
                    ? selectEl.options[selectEl.selectedIndex].text 
                    : "-";

    const isLeftWin = container.classList.contains("left-block");

    if (!nameEl || nameEl.style.display === "none" || trimmedName === ""){
      winnerText = selText === "-" ? (isLeftWin ? "L Blader\nWIN!!" : "R Blader\nWIN!!") : `${selText}\nWIN!!`;
    } else {
      winnerText = `${trimmedName}\nWIN!!`;
    }

    div.textContent = winnerText;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 5000);

    leftArea.classList.remove("stop");
    rightArea.classList.remove("stop");

    const winnerSide = container.classList.contains("left-block") ? "left" : "right";
    showWinEffect(winnerSide);

  } else {
    leftArea.classList.remove("active");
    rightArea.classList.remove("active");
    leftArea.classList.add("stop");
    rightArea.classList.add("stop");
    scoreEl.classList.remove("pulse");
  }

  scoreChangePending = true;
}


function updateBladerVisibility() {
  const leftBlader = document.getElementById("left-blader");
  const rightBlader = document.getElementById("right-blader");

  leftBlader.style.display = leftBlader.textContent.trim() === "" ? "none" : "block";
  rightBlader.style.display = rightBlader.textContent.trim() === "" ? "none" : "block";
}

updateBladerVisibility();

document.getElementById("left-blader").addEventListener("input", updateBladerVisibility);
document.getElementById("right-blader").addEventListener("input", updateBladerVisibility);

function showWinEffect(winnerSide) {
  const leftArea = document.getElementById("leftArea");
  const rightArea = document.getElementById("rightArea");

  leftArea.classList.remove("active");
  rightArea.classList.remove("active");

  if (winnerSide === "left") {
    leftArea.classList.add("active");
  } else {
    rightArea.classList.add("active");
  }
}

function handleFrameTap(block,frame){
  const isRemove = frame.querySelector(".hud-ring");
  if(isRemove){
    const huds = [...block.querySelectorAll(".hud-ring")];
    huds.sort((a,b)=>b.parentElement.offsetTop - a.parentElement.offsetTop)[0].remove();
  } else {
    const empty = [...block.querySelectorAll(".frame")].find(f => !f.querySelector(".hud-ring"));
    if(!empty) return;
    const img = document.createElement("img");
    img.className = block.classList.contains("right-block") 
  ? "hud-ring right cyber-effect"
  : "hud-ring cyber-effect";
    img.src = block.classList.contains("right-block") ? "HudLing-pink.png" : "HudLing.png";
    empty.append(img);
  }
  updateScore(block);
}

document.querySelectorAll(".left-block .frame, .right-block .frame").forEach(f=>{
  f.onclick=e=>handleFrameTap(f.closest(".left-block, .right-block"),f);
});
  
const ranks=["1st","2nd","3rd","4th","5th","6th","7th"];
let r=0;
const centerRank=document.getElementById("center-rank");

centerRank.onclick = () => {
  const leftScore = parseInt(document.getElementById("score-left").textContent);
  const rightScore = parseInt(document.getElementById("score-right").textContent);

  if (leftScore === 0 && rightScore === 0) {
    showRankUpEffect(ranks[r]);
    return;
  }

  if(leftScore === 4 || rightScore === 4){
    document.querySelectorAll(".hud-ring").forEach(h => h.remove());
    document.getElementById("score-left").textContent = "0";
    document.getElementById("score-right").textContent = "0";
    r = 0;
    centerRank.textContent = ranks[r];
    leftArea.classList.remove("active");
    rightArea.classList.remove("active");
    leftArea.classList.add("stop");
    rightArea.classList.add("stop");
    return;
  }

  r = (r + 1) % ranks.length;
  centerRank.textContent = ranks[r];
  showRankUpEffect(ranks[r]);
};


function checkScoreForRank(){
  if(scoreTimer) clearTimeout(scoreTimer);

  scoreTimer = setTimeout(() => {
    const newLeft = parseInt(document.getElementById("score-left").textContent);
    const newRight = parseInt(document.getElementById("score-right").textContent);

    if(newLeft === 4 || newRight === 4){
      scoreTimer = null;
      return;
    }

    if(newLeft > lastScores.left || newRight > lastScores.right) {
      r = (r + 1) % ranks.length;
      centerRank.textContent = ranks[r];
      
      showRankUpEffect(ranks[r]);

      lastScores.left = newLeft;
      lastScores.right = newRight;
    }

    scoreTimer = null;
  }, 4000);
}


function showRankUpEffect(rank) {
  const container = document.createElement('div');
  container.className = 'rankup-container';
  container.style.position = 'fixed';
  container.style.top = '50%';
  container.style.left = '50%';
  container.style.transform = 'translate(-50%, -50%)';
  container.style.zIndex = 9999;
  container.style.pointerEvents = 'none';
  container.innerHTML = `
    <svg width="1000" height="250">
      <text x="50%" y="40%" class="outline big" style="font-family:'EvogriaItalic', sans-serif; text-anchor:middle; dominant-baseline:middle;">${rank}</text>
      <text x="50%" y="75%" class="outline small" style="font-family:'EvogriaItalic', sans-serif; text-anchor:middle; dominant-baseline:middle;">Battle</text>
      <text x="50%" y="40%" class="fill big" style="font-family:'EvogriaItalic', sans-serif; text-anchor:middle; dominant-baseline:middle;">${rank}</text>
      <text x="50%" y="75%" class="fill small" style="font-family:'EvogriaItalic', sans-serif; text-anchor:middle; dominant-baseline:middle;">Battle</text>
    </svg>
  `;
  document.body.appendChild(container);

  const fills = container.querySelectorAll('.fill');

  setTimeout(() => {
    container.querySelectorAll('.outline').forEach(el => {
      el.style.animation = 'reverseDraw 1s ease forwards';
    });
    container.querySelectorAll('.fill').forEach(el => {
      el.style.animation = 'fadeOut 1s ease forwards';
    });

    setTimeout(() => container.remove(), 1000);
  }, 3000);

  return container; 

}

window.addEventListener('DOMContentLoaded', () => {
  showRankUpEffect(ranks[r]); 
});


</script>
</body>
</html>
