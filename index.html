<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="apple-touch-icon" sizes="180x180" href="https://i.imgur.com/gljnX0R.png"><!-- iOSホーム画面用アイコン -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00D4FF">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CameraScore">
<link rel="apple-touch-icon" href="https://i.imgur.com/gljnX0R.png">
<title>CameraScore</title>
<style>
/* ==== フォント ==== */
@font-face {
  font-family: 'CyberFont';
  src: url('CyberFont.ttf') format('truetype');
}
@font-face {
  font-family: 'DS-DIGIB';
  src: url('DS-DIGIB.ttf') format('truetype');
}

/* ==== 基本 ==== */
body,html { margin:0;padding:0;height:100%;background:black;font-family:'CyberFont',sans-serif; }
video#camera { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; z-index:0; }
.bi-border{position:absolute;inset:0;pointer-events:none;background:url('bi.png')center/contain no-repeat;opacity:.6;filter:drop-shadow(0 0 20px #0ff);animation:glow 2s infinite alternate;z-index:1;}
@keyframes glow{0%{filter:drop-shadow(0 0 10px #0ff)}50%{filter:drop-shadow(0 0 25px #0ff)}100%{filter:drop-shadow(0 0 10px #0ff)}}

.ui-layer{position:absolute;inset:0;z-index:2;}

/* ==== 選択ボックス ==== */
select,select option {font-family:'CyberFont'!important;letter-spacing:1px;}
.left-block select,.right-block select {
  font-size:1.3rem;width:40vw;max-width:400px;min-width:120px;
  padding:10px 12px;margin-bottom:10px;background:rgba(0,0,0,.6);
  color:#fff;border-radius:8px;border:2px solid;appearance:none;cursor:pointer;
}
.left-block select{border-color:#aaffff;}
.right-block select{border-color:#ffaaaa;text-align-last:right;}

.left-block select option,.right-block select option{font-size:1.3rem;}

.left-block,.right-block{
  position:absolute;top:20px;display:flex;flex-direction:column;pointer-events:auto;
}
.left-block{left:20px;}
.right-block{right:20px;align-items:flex-end;}

/* ==== フレーム ==== */
.frame-container{display:flex;flex-direction:column;gap:0;}

.frame{
  width:60px;
  height:10vh;
  border:2px solid;
  position:relative;
  overflow: hidden;
  pointer-events:auto;
  background:rgba(0,0,0,.7);
  backdrop-filter:blur(4px);
  box-shadow:0 0 15px,inset 0 0 30px;
}

.frame.blue{border-color:#aaffff;box-shadow:0 0 15px #aaffff,inset 0 0 30px #aaffff;}
.frame.pink{border-color:#ffaaaa;box-shadow:0 0 15px #ffaaaa,inset 0 0 30px #ffaaaa;}

.hud-ring{
position:absolute;
top:50%;
left:50%;
width:70px;
height:70px;
transform:translate(-50%,-50%);
animation:hudSpin 3s linear infinite;
pointer-events:none;
}
@keyframes hudSpin{from{transform:translate(-50%,-50%) rotate(0)}to{transform:translate(-50%,-50%) rotate(360deg)}}

/* ==== スコア ==== */
.score{font-family:'DS-DIGIB'!important;font-size:25vh;color:#ffdd99;text-shadow:0 0 10px #ffaa33,0 0 20px #ffaa33,0 0 40px #ff4400;pointer-events:auto;}
.score-container{display:flex;align-items:center;gap:.8vw;}

.left-score-container .blader-name{border:2px solid #aaffff;}
.right-score-container .blader-name{border:2px solid #ffaaaa;}

.blader-name{
  padding:8px 12px;background:rgba(0,0,0,.6);color:#fff;border-radius:8px;
  font-size:1.6rem;cursor:text;white-space:nowrap;
}

/* ==== ラウンド ==== */
.center-block{position:absolute;top:10px;left:50%;transform:translateX(-50%);text-align:center;z-index:3;}
.center-battle{font-size:1rem;color:#fff;}
.center-rank{font-size:2rem;color:#fff;border-bottom:2px solid #fff;cursor:pointer;user-select:none;}

/* ==== WIN ==== */
.win-overlay{
  position:fixed;inset:0;display:flex;justify-content:center;align-items:center;
  background:rgba(255,255,255,.2);color:#ffea50;font-size:8vw;white-space:pre-line;
  text-shadow:0 0 10px #fff59e,0 0 20px #ffea50,0 0 40px #ffdd33;z-index:1000;
  animation:winFlash 4s forwards;
}
@keyframes winFlash{0%{transform:scale(.5);opacity:0}20%{transform:scale(1.5);opacity:1}100%{transform:scale(1);opacity:0}}

/* ==== モーダル ==== */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(6px);
  display:none;align-items:center;justify-content:center;z-index:2000;
}
.modal-content{
  background:#0B0E1A;border:2px solid #00D4FF;width:90%;max-width:420px;
  padding:20px;border-radius:12px;color:#fff;
}
.modal-content.right{border-color:#FF33D4;}
.modal-content h2{text-align:center;margin-bottom:10px;}

.deck-input
{width:100%;
padding:12px;
margin-bottom:10px;
font-size:1.1rem;
font-family:'CyberFont',sans-serif;
background:rgba(0,0,0,.6);
border:2px solid #00eaff;
color:#fff;
box-sizing: border-box;
}

.modal-save-btn{
width:100%;
padding:12px;margin-top:12px;font-size:1.1rem;
font-family:'CyberFont',sans-serif;
background:#00D4FF;
font-weight:bold;
border-radius:6px;
cursor:pointer;
color: #000 !important;
}

.modal-save-btn.right{
background:#FF33D4;
color: #000 !important;
}

.deck-input.right {
  border-color: #FF33D4 !important;

/* ==== HUD サイバーエフェクト ==== */
.hud-ring.cyber-effect {
  animation: hudGlitch 1s infinite alternate, hudSpin 3s linear infinite;
}

@keyframes hudGlitch {
  0% { filter: drop-shadow(0 0 5px #0ff); opacity: 0.7; }
  25% { filter: drop-shadow(0 0 20px #0ff); opacity: 1; }
  50% { filter: drop-shadow(0 0 10px #0ff); opacity: 0.8; }
  75% { filter: drop-shadow(0 0 25px #0ff); opacity: 1; }
  100% { filter: drop-shadow(0 0 5px #0ff); opacity: 0.7; }
}

/* ==== スコア脈打ちエフェクト ==== */
.score.pulse {
  animation: scorePulse 1.5s infinite;
}

@keyframes scorePulse {
  0% { transform: scale(1); color: #ffdd99; }
  50% { transform: scale(1.1); color: #fff56e; }
  100% { transform: scale(1); color: #ffdd99; }
}

</style>
</head>
<body>

<video id="camera" autoplay playsinline></video>
<div class="bi-border"></div>

<div class="ui-layer">
  
  <!-- LEFT -->
  <div class="left-block">
    <select class="blade-select" data-side="left"></select>
    <div class="frame-container left-frames">
      <div class="frame blue"></div><div class="frame blue"></div><div class="frame blue"></div><div class="frame blue"></div>
    </div>
    <div class="score-container left-score-container">
      <div class="score" id="score-left">0</div>
      <div class="blader-name" id="left-blader" contenteditable>BLADER A</div>
    </div>
  </div>

  <!-- CENTER -->
  <div class="center-block">
    <div class="center-battle">Battle</div>
    <div class="center-rank" id="center-rank">1st</div>
  </div>

  <!-- RIGHT -->
  <div class="right-block">
    <select class="blade-select" data-side="right"></select>
    <div class="frame-container right-frames">
      <div class="frame pink"></div><div class="frame pink"></div><div class="frame pink"></div><div class="frame pink"></div>
    </div>
    <div class="score-container right-score-container">
      <div class="blader-name" id="right-blader" contenteditable>BLADER B</div>
      <div class="score" id="score-right">0</div>
    </div>
  </div>
</div>

<!-- Deck Modal -->
<div id="deckModal" class="modal-overlay">
  <div id="deckModalContent" class="modal-content">
    <h2>デッキ編集</h2>
    <input class="deck-input" id="deck1">
    <input class="deck-input" id="deck2">
    <input class="deck-input" id="deck3">
    <button id="saveDeckBtn" class="modal-save-btn">Save</button>
  </div>
</div>

<script>
/* ==== カメラ + マイク ==== */
navigator.mediaDevices.getUserMedia({
  video: { facingMode: "environment" } // 背面カメラのみ
})
.then(stream => {
  const video = document.getElementById("camera");
  video.srcObject = stream;
})
.catch(err => console.error("カメラ起動失敗:", err));

/* ==== 初期デッキ ==== */
let leftDeck = ["BayBlade A","BayBlade B","BayBlade C"];
let rightDeck = ["BayBlade A","BayBlade B","BayBlade C"];
let scoreChangePending = false;

function setSelectOptions(select){
  select.innerHTML = "";
  const deck = select.dataset.side === "left" ? leftDeck : rightDeck;

  deck.forEach(v=>{
    const o=document.createElement("option");
    o.textContent=v;
    select.appendChild(o);
  });

  select.append(new Option("-"), new Option("デッキ編集"));
  select.value = "-";
}

document.querySelectorAll(".blade-select").forEach(setSelectOptions);

/* ==== デッキ編集 ==== */
const deckModal=document.getElementById("deckModal");
let currentSelect=null;

document.querySelectorAll(".blade-select").forEach(sel=>{
  sel.addEventListener("change",e=>{
    const v=e.target.value;
    
    // ✅ スコア後の最初の選択変更なら rank を1つ進める
    if(scoreChangePending && v !== "デッキ編集" && v !== "-"){
      scoreChangePending = false; // 1回だけ
      r = (r + 1) % ranks.length;
      centerRank.textContent = ranks[r];
    }
    
    if(v === "デッキ編集"){
      currentSelect = e.target;
      deckModal.style.display = "flex";

      const modal = document.getElementById("deckModalContent");
      const saveBtn = document.getElementById("saveDeckBtn");

      // ✅ 選択ボックスのボーダーカラーを取得
      const borderColor = window.getComputedStyle(currentSelect).borderColor;

      // ✅ モーダル枠の色適用
      modal.style.borderColor = borderColor;

      // ✅ 保存ボタンに色を反映
      saveBtn.style.borderColor = borderColor;
      saveBtn.style.color = "#ffffff"; 
      saveBtn.style.backgroundColor = borderColor; // ← 追加

      // ✅ 入力欄に色を反映
      const inputs = [deck1, deck2, deck3];
      inputs.forEach((inp,i)=>{
        inp.value = currentSelect.options[i]?.text || "";
        inp.style.borderColor = borderColor;
      });
    }
    if(v==="-"){
      e.target.selectedIndex=0;
    }
  });
});

saveDeckBtn.onclick = () => {
  const deckValues = [deck1.value.trim(), deck2.value.trim(), deck3.value.trim()];

  // 未入力チェック
  if(deckValues.some(v => v === "")) {
    alert("未入力があります");
    return; // 保存中止
  }

  if(currentSelect.dataset.side === "left"){
    leftDeck = deckValues;
  } else {
    rightDeck = deckValues;
  }

  document.querySelectorAll(".blade-select").forEach(setSelectOptions);
  currentSelect.value = "-";
  deckModal.style.display = "none";
  resetBattleState();
};



function resetBattleState() {
  // スコアリセット
  document.getElementById("score-left").textContent = "0";
  document.getElementById("score-right").textContent = "0";

  // HUD削除
  document.querySelectorAll(".hud-ring").forEach(h => h.remove());

  // ランクを1stにリセット
  r = 0;
  centerRank.textContent = ranks[r];
}

/* ==== HUD & SCORE ==== */
function updateScore(container){
  const scoreEl = container.querySelector(".score");
  const count = container.querySelectorAll(".hud-ring").length;

  // スコア変動エフェクト
  if(scoreEl.textContent != count){ // 前回と異なる場合
    scoreEl.textContent = count;
    scoreEl.style.transform = "scale(1.5)";
    scoreEl.style.transition = "transform 0.3s";
    setTimeout(() => {
      scoreEl.style.transform = "scale(1)";
    }, 50);
  }

  // WIN判定
  if(count === 4){
    const name = container.querySelector(".blader-name").textContent;
    const div = document.createElement("div");
    div.className = "win-overlay";
    div.textContent = `${name}\nWIN‼︎`;
    document.body.append(div);
    setTimeout(() => div.remove(), 2000);
  }

  scoreChangePending = true; // rank用フラグ
}

function handleFrameTap(block,frame){
  const isRemove = frame.querySelector(".hud-ring");
  if(isRemove){
    const huds = [...block.querySelectorAll(".hud-ring")];
    huds.sort((a,b)=>b.parentElement.offsetTop - a.parentElement.offsetTop)[0].remove();
  } else {
    const empty = [...block.querySelectorAll(".frame")].find(f => !f.querySelector(".hud-ring"));
    if(!empty) return;
    const img = document.createElement("img");
    img.className = "hud-ring cyber-effect";
    img.src = block.classList.contains("right-block") ? "HudLing-pink.png" : "HudLing.png";
    empty.append(img);
  }
  updateScore(block);
}

document.querySelectorAll(".left-block .frame, .right-block .frame").forEach(f=>{
  f.onclick=e=>handleFrameTap(f.closest(".left-block, .right-block"),f);
});

/* ==== ランク ==== */
const ranks=["1st","2nd","3rd","4th","5th","6th","7th"];
let r=0;
const centerRank=document.getElementById("center-rank");

centerRank.onclick = () => {
  const leftScore = parseInt(document.getElementById("score-left").textContent);
  const rightScore = parseInt(document.getElementById("score-right").textContent);
  
  let rankPressTimer = null;
    
  // 長押し判定開始
  centerRank.addEventListener("mousedown", () => {
    rankPressTimer = setTimeout(() => {
      if(r > 0){ // 1st以下には戻さない
        r = r - 1; // 1つ戻す
        centerRank.textContent = ranks[r];
      }
    }, 500); // 500ms以上で発火
  });

  // 長押し解除
  centerRank.addEventListener("mouseup", () => clearTimeout(rankPressTimer));
  centerRank.addEventListener("mouseleave", () => clearTimeout(rankPressTimer));

  // 条件：どちらかが4点
  if(leftScore === 4 || rightScore === 4){
    if(confirm("クリアしますか？")){
      // HUD削除
      document.querySelectorAll(".hud-ring").forEach(h=>h.remove());

      // スコアリセット
      document.getElementById("score-left").textContent = "0";
      document.getElementById("score-right").textContent = "0";

      // Rank を1stに戻す
      r = 0;
      centerRank.textContent = ranks[r];
    }
    return; // 以降 rank変更処理は行わない
  }

  // 通常の rank 進め処理
  r = (r + 1) % ranks.length;
  centerRank.textContent = ranks[r];
};
</script>
</body>
</html>
