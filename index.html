<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CameraScore</title>
<style>
/* フォント定義は環境によるので任意で差し替え */
body, html { margin:0; padding:0; height:100%; background:black; font-family: sans-serif; }
video#camera { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; z-index:0; }

.ui-layer { position:absolute; inset:0; pointer-events:none; z-index:1; }

.bi-border {
  position:absolute; inset:0; pointer-events:none; z-index:0;
  background-image: url('bi.png'); background-size:contain; background-position:center; background-repeat:no-repeat;
  opacity:.6; filter: drop-shadow(0 0 20px #0ff);
  animation: glow 2s infinite alternate;
}
@keyframes glow { 0%{filter:drop-shadow(0 0 10px #0ff)} 50%{filter:drop-shadow(0 0 25px #0ff)} 100%{filter:drop-shadow(0 0 10px #0ff)} }

/* 左右ブロック */
.left-block, .right-block {
  position:absolute; top:20px; display:flex; flex-direction:column; pointer-events:auto;
}
.left-block { left:20px; }
.right-block { right:20px; align-items:flex-end; }

/* 選択ボックス */
.left-block select, .right-block select {
  width:40vw; max-width:400px; min-width:120px;
  padding:10px 12px; margin-bottom:10px; background:rgba(0,0,0,.7); color:#fff; border-radius:8px; border:2px solid;
  appearance:none; cursor:pointer; box-sizing:border-box;
}
.left-block select { border-color:#aaffff; }
.right-block select { border-color:#ffaaaa; text-align-last:right; }

/* フレーム群 */
.frame-container { display:flex; flex-direction:column; gap:0; }
.frame {
  width:60px; height:10vh; border:3px solid; position:relative; overflow:hidden;
  background: rgba(0,0,0,.7); backdrop-filter: blur(4px);
  box-shadow: 0 0 15px, inset 0 0 30px; transition:transform .3s, box-shadow .3s;
}
.frame + .frame { border-top-left-radius:0; border-top-right-radius:0; }

/* 色 */
.frame.blue { border-color:#aaffff; box-shadow:0 0 15px #aaffff, inset 0 0 30px #aaffff;}
.frame.pink { border-color:#ffaaaa; box-shadow:0 0 15px #ffaaaa, inset 0 0 30px #ffaaaa; }

/* HUD 画像（中央に収める） */
.hud-ring {
  position:absolute;
  top:50%; left:50%;
  width:80%; height:80%;
  transform:translate(-50%,-50%);
  object-fit:contain;
  pointer-events:none;
  animation: hudSpin 3s linear infinite;
}
@keyframes hudSpin { from{transform:translate(-50%,-50%) rotate(0deg)} to{transform:translate(-50%,-50%) rotate(360deg)} }

/* 以前の円（cyber-circle）を残したい場合はそのまま */
.cyber-circle {
  position:absolute; width:55%; height:55%; border-radius:50%;
  top:50%; left:50%; transform:translate(-50%,-50%); pointer-events:none;
  animation: noiseSlow 4s infinite steps(5);
}
@keyframes noiseSlow { 0%{opacity:.15;filter:blur(1px)} 25%{opacity:.95;filter:blur(0)} 100%{opacity:.6;filter:blur(.3px)} }

/* スコア表示 */
.score { font-family: monospace; font-size:25vh; color:#ffdd99; margin-top:5px; text-align:center;
  text-shadow: 0 0 10px #ffaa33,0 0 20px #ffaa33,0 0 40px #ff4400;
  pointer-events:auto;
}
.score.flash { animation: scoreFlash .25s ease-out; }
@keyframes scoreFlash { 0%{transform:scale(1)}50%{transform:scale(1.25)}100%{transform:scale(1)} }

/* finish */
.finish-flash {
  position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:99;
  background: rgba(255,255,255,.95); backdrop-filter: blur(3px);
  color:#ffea50; font-family:inherit; font-size:8vw; text-shadow:0 0 25px #fff59e;
  pointer-events:none;
  animation: finishBlink 5s ease-out forwards;
}
@keyframes finishBlink {
  0% { opacity:0 }
  5% { opacity:1 }     /* 瞬間フェードイン */
  100% { opacity:0 }   /* ゆっくりフェードアウト */
}

/* スコアコンテナとブレーダー名 */
.score-container { display:flex; align-items:center; gap:.8vw; pointer-events:auto; }
.blader-name { padding:5px 10px; background:rgba(0,0,0,.7); color:#fff; border:2px solid #ffdd99; border-radius:8px; cursor:text; white-space:nowrap; }

</style>
</head>
<body>

<video id="camera" autoplay playsinline></video>
<div class="bi-border"></div>

<div class="ui-layer">
  <!-- 左 -->
  <div class="left-block">
    <select class="left-select">
      <option>ウィザードロッド3-60B</option>
      <option>ブラストW9-60LR</option>
      <option>シャークスケイル1-60FB</option>
    </select>
    <div class="frame-container left-frames">
      <div class="frame blue"></div>
      <div class="frame blue"></div>
      <div class="frame blue"></div>
      <div class="frame blue"></div>
    </div>
    <div class="score-container left-score-container">
      <div class="score" id="score-left">0</div>
      <div class="blader-name" contenteditable="true" id="left-blader">BLADER A</div>
    </div>
  </div>

  <!-- 右 -->
  <div class="right-block">
    <select class="right-select">
      <option>ウィザードロッド3-60B</option>
      <option>ブラストW9-60LR</option>
      <option>シャークスケイル1-60FB</option>
    </select>
    <div class="frame-container right-frames">
      <div class="frame pink"></div>
      <div class="frame pink"></div>
      <div class="frame pink"></div>
      <div class="frame pink"></div>
    </div>
    <div class="score-container right-score-container">
      <div class="blader-name" contenteditable="true" id="right-blader">BLADER B</div>
      <div class="score" id="score-right">0</div>
    </div>
  </div>
</div>

<script>
// カメラ取得（任意）
navigator.mediaDevices?.getUserMedia?.({ video:{ facingMode:'environment' }, audio:false })
  .then(s => document.getElementById('camera').srcObject = s)
  .catch(e => console.warn('カメラ取得失敗:', e));

// updateScore: コンテナ（.left-block か .right-block）を渡す
function updateScore(container) {
  if (!container) return;
  // カウントする要素を拡張：cyber-circle と hud-ring を両方数える
  const count = container.querySelectorAll('.cyber-circle, .hud-ring').length;
  const scoreEl = container.querySelector('.score');
  if (scoreEl) scoreEl.textContent = String(count);
  // animation トリガー
  if (scoreEl) {
    scoreEl.classList.remove('flash');
    void scoreEl.offsetWidth;
    scoreEl.classList.add('flash');
  }
  if (count === 4) showFinishEffect('FINISH!');
}

function showFinishEffect(text){
  const div = document.createElement('div');
  div.className = 'finish-flash';
  div.textContent = text;
  document.body.appendChild(div);
  // remove after animation (same duration 5s)
  setTimeout(()=>div.remove(), 5200);
}

// フレームクリックで HUD を toggle（画像を追加/削除）
function toggleHud(frame) {
  const existing = frame.querySelector('.hud-ring');
  if (existing) {
    existing.remove();
  } else {
    const img = document.createElement('img');
    img.src = 'HudLing.png'; // 同ディレクトリの画像ファイル名
    img.className = 'hud-ring';
    frame.appendChild(img);
  }
  // 親ブロック（左 or 右）を再計算して更新
  const container = frame.closest('.left-block, .right-block');
  updateScore(container);
}

// クリックでHUD切替
document.querySelectorAll('.frame').forEach(frame=>{
  frame.addEventListener('click', (e)=>{
    // フレーム上のクリックは HUD toggle のみ
    // （frame 内へ要素を追加しているので pointer-events:none なら重ならない）
    toggleHud(frame);
  });
});

// 選択ボックスが変わったら該当ブロックだけクリア
document.querySelectorAll('.left-select, .right-select').forEach(sel=>{
  sel.addEventListener('change', (e)=>{
    const block = sel.closest('.left-block, .right-block');
    if (!block) return;
    // フレーム内の HUD と cyber-circle を全て削除
    block.querySelectorAll('.hud-ring, .cyber-circle').forEach(n=>n.remove());
    // リセットスコア
    const scoreEl = block.querySelector('.score');
    if (scoreEl) scoreEl.textContent = '0';
  });
});

// 初期スコア更新
document.querySelectorAll('.left-block, .right-block').forEach(block=>updateScore(block));

</script>
</body>
</html>
