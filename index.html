mada
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CameraScore</title>
<style>
@font-face {
  font-family: 'CyberFont';
  src: url('CyberFont.ttf') format('truetype');
}

@font-face {
  font-family: 'DS-DIGIB';
  src: url('DS-DIGIB.ttf') format('truetype');
}
/* フォント定義は環境によるので任意で差し替え */
body, html { margin:0; padding:0; height:100%; background:black; font-family: 'CyberFont', sans-serif; }
video#camera { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; z-index:0; }


.score {
  font-family: 'DS-DIGIB', monospace !important;
}
  
.score-display {
  font-size: 20vh; /* ←ここは20%の指定だったはず。必要に応じて修正 */
  color: #fff; 
  text-shadow: 0 0 10px orange, 0 0 20px orange, 0 0 40px orange;
}
  
.ui-layer { 
  position:absolute; 
  inset:0; 
  z-index:1; 
}

.bi-border {
  position:absolute; inset:0; pointer-events:none; z-index:0;
  background-image: url('bi.png'); background-size:contain; background-position:center; background-repeat:no-repeat;
  opacity:.6; filter: drop-shadow(0 0 20px #0ff);
  animation: glow 2s infinite alternate;
}
@keyframes glow { 0%{filter:drop-shadow(0 0 10px #0ff)} 50%{filter:drop-shadow(0 0 25px #0ff)} 100%{filter:drop-shadow(0 0 10px #0ff)} }

/* 左右ブロック */
.left-block, .right-block {
  position:absolute; top:20px; display:flex; flex-direction:column; pointer-events:auto;
}
.left-block { left:20px; }
.right-block { right:20px; align-items:flex-end; }

/* 選択ボックスもCyberFontに */
select, select option {
  font-family: 'CyberFont', sans-serif !important;
  letter-spacing: 1px;
}

  /* カード上のブレーダー選択box */
.blader-select {
    font-size: 1.3rem; /* 元より少し大きめ */
}

/* 4点取得時の表示背景 */
.win-overlay {
  position: fixed;
  inset: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: rgba(255, 255, 255, 0.2);
  color: #ffea50;
  font-family: 'CyberFont', sans-serif;
  font-size: 8vw;         /* 画面幅に応じて可変 */
  text-align: center;
  white-space: pre-line;   /* 改行を反映 */
  text-shadow: 
     0 0 10px #fff59e,
     0 0 20px #ffea50,
     0 0 40px #ffdd33,
     0 0 60px #ffdd33;
  z-index: 1000;
  animation: winFlash 4s ease-out forwards;
}

@keyframes winFlash {
  0% {
    transform: scale(0.5);
    opacity: 0;
  }
  20% {
    transform: scale(1.5);
    opacity: 1;
  }
  50% {
    transform: scale(1.2);
    opacity: 1;
  }
  80% {
    transform: scale(1);
    opacity: 0.8;
  }
  100% {
    transform: scale(1);
    opacity: 0;
  }
}

/* 選択ボックス */
/* 左右ブロックの選択ボックス */
.left-block select,
.right-block select {
  font-size: 1.3rem;   /* 元の 1.5rem から少し大きく */
  font-family: 'CyberFont', sans-serif !important;
  letter-spacing: 1px;
  width: 40vw;
  max-width: 400px;
  min-width: 120px;
  padding: 10px 12px;
  margin-bottom: 10px;
  background: rgba(0,0,0,0.6);
  color: #fff;
  border-radius: 8px;
  border: 2px solid;
  appearance: none;
  cursor: pointer;
  box-sizing: border-box;
}

.left-block select { border-color: #aaffff; }
.right-block select { border-color: #ffaaaa; text-align-last: right; }

/* optionも文字サイズを大きく */
.left-block select option,
.right-block select option {
  font-size: 1.3rem;  /* selectと同じサイズに合わせる */
}
/* フレーム群 */
.frame-container { display:flex; flex-direction:column; gap:0; }
.frame {
  width:60px; height:10vh; 
  border:2px solid; 
  position:relative; 
  pointer-events: auto;
  overflow:hidden;
  background: rgba(0,0,0,.7); 
  backdrop-filter: blur(4px);
  box-shadow: 0 0 15px, inset 0 0 30px; 
  transition:transform .3s, box-shadow .3s;
}
.frame + .frame { border-top-left-radius:0; border-top-right-radius:0; }

/* 色 */
.frame.blue { border-color:#aaffff; box-shadow:0 0 15px #aaffff, inset 0 0 30px #aaffff;}
.frame.pink { border-color:#ffaaaa; box-shadow:0 0 15px #ffaaaa, inset 0 0 30px #ffaaaa; }

/* HUD 画像（中央に収める） */
.hud-ring {
  position:absolute;
  top:50%;
  left:50%;
  width:80px;
  height:80px;
  transform:translate(-50%,-50%);
  object-fit:contain;
  pointer-events:none;
  animation: hudSpin 3s linear infinite;
}
@keyframes hudSpin { from{transform:translate(-50%,-50%) rotate(0deg)} to{transform:translate(-50%,-50%) rotate(360deg)} }

/* 以前の円（cyber-circle）を残したい場合はそのまま */
.cyber-circle {
  position:absolute; width:55%; height:55%; border-radius:50%;
  top:50%; left:50%; transform:translate(-50%,-50%); pointer-events:none;
  animation: noiseSlow 4s infinite steps(5);
}
@keyframes noiseSlow { 0%{opacity:.15;filter:blur(1px)} 25%{opacity:.95;filter:blur(0)} 100%{opacity:.6;filter:blur(.3px)} }

/* スコア表示 */
.score { font-family: monospace; font-size:25vh; color:#ffdd99; margin-top:5px; text-align:center;
  text-shadow: 0 0 10px #ffaa33,0 0 20px #ffaa33,0 0 40px #ff4400;
  pointer-events:auto;
}
.score.flash { animation: scoreFlash .25s ease-out; }
@keyframes scoreFlash { 0%{transform:scale(1)}50%{transform:scale(1.25)}100%{transform:scale(1)} }

/* finish */
.finish-flash {
  position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:99;
  background: rgba(255,255,255,0.8); backdrop-filter: blur(3px);
  color:#ffea50; font-family:inherit; font-size:8vw; text-shadow:0 0 25px #fff59e;
  pointer-events:none;
  animation: finishBlink 4s ease-out forwards;
}
@keyframes finishBlink {
  0% { opacity:0 }
  5% { opacity:1 }     /* 瞬間フェードイン */
  100% { opacity:0 }   /* ゆっくりフェードアウト */
}


/* スコアコンテナとブレーダー名 */
.score-container { display:flex; align-items:center; gap:.8vw; pointer-events:auto; }

/* 左ブレーダー名 */
.left-score-container .blader-name {
    padding: 8px 12px;
    background: rgba(0,0,0,0.6);
    color: #fff;
    border: 2px solid #aaffff; /* 左選択ボックスの色に合わせる */
    border-radius: 8px;
    cursor: text;
    white-space: nowrap;
    font-size: 1.6rem; /* フォントサイズを大きく */
}

/* 右ブレーダー名 */
.right-score-container .blader-name {
    padding: 8px 12px;
    background: rgba(0,0,0,0.6);
    color: #fff;
    border: 2px solid #ffaaaa; /* 右選択ボックスの色に合わせる */
    border-radius: 8px;
    cursor: text;
    white-space: nowrap;
    font-size: 1.6rem; /* フォントサイズを大きく */
}
.blader-name { 
  padding:5px 10px; 
  background:rgba(0,0,0,0.6); 
  color:#fff; 
  border:2px solid #ffdd99; 
  border-radius:8px; 
  cursor:text; 
  white-space:nowrap; 
  pointer-events: auto;
}


/* スコア加点時の光と拡大エフェクト */
.score-bonus {
  animation: scoreBonus 0.5s ease-out forwards;
}

@keyframes scoreBonus {
  0%   { transform: scale(1); text-shadow: 0 0 10px #ffaa33, 0 0 20px #ffaa33; color:#ffdd99; }
  30%  { transform: scale(1.5); text-shadow: 0 0 20px #fff, 0 0 40px #ffea50; color:#fff59e; }
  60%  { transform: scale(1.3); text-shadow: 0 0 15px #ffdd33, 0 0 30px #ffaa33; color:#ffdd33; }
  100% { transform: scale(1); text-shadow: 0 0 10px #ffaa33, 0 0 20px #ffaa33; color:#ffdd99; }
}

.center-block {
  position: absolute;
  top: 10px;             
  left: 50%;
  transform: translateX(-50%);
  text-align: center;
  pointer-events: auto;   
  z-index: 2;
}

.center-battle {
  font-family: 'CyberFont', sans-serif;
  font-size: 1rem;      
  color: #fff;
  text-shadow: 0 0 5px #fff;
  margin-bottom: 0px;
}

.center-rank {
  font-family: 'CyberFont', sans-serif;
  font-size: 2rem;
  color: #fff;
  cursor: pointer;
  user-select: none;
  padding: 2px 6px;
  text-shadow: 0 0 5px #fff;
  border-bottom: 2px solid #fff; /* optional: 下線でクリック可能感を出す */
}

.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(6px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2000;
  animation: fadeIn .25s ease;
}

.modal.hidden {
  display: none;
}

/* ★ モーダルの背景を透明60%に */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.6); /* 透明度60% */
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 999;
}

/* 共通：モーダルボックス */
.modal-content {
  background: #0B0E1A;
  border: 2px solid #00D4FF; /* 左側デフォルト色 */
  padding: 20px;
  width: 90%;
  max-width: 420px;
  border-radius: 12px;
  box-shadow: 0 0 15px rgba(0,212,255,0.5);
}

/* ★ 右側の時（ピンク） */
.modal-content.right {
  border-color: #FF33D4;
  box-shadow: 0 0 15px rgba(255,51,212,0.5);
}

/* 保存ボタン共通 */
.modal-save-btn {
  width: 100%;
  padding: 12px;
  font-size: 18px;
  border: none;
  border-radius: 8px;
  margin-top: 20px;
  cursor: pointer;
  font-weight: bold;
  background: #00D4FF;
}

/* ★ 右側時ボタン色をピンクに */
.modal-save-btn.right {
  background: #FF33D4;
}

.modal-content h2 {
  color: #fff;
  text-align: center;
  margin-bottom: 15px;
  font-family: 'CyberFont';
}

.modal-content input {
  width: 100%;
  padding: 12px;
  margin-bottom: 12px;
  font-size: 1.1rem;
  border: 2px solid #00eaff;
  border-radius: 6px;
  background: rgba(0,0,0,0.65);
  color: #fff;
  font-family: 'CyberFont';
}

.modal-buttons {
  display: flex;
  justify-content: space-between;
  margin-top: 8px;
}

.modal-buttons button {
  width: 48%;
  padding: 12px 0;
  font-size: 1.1rem;
  font-family: 'CyberFont';
  border-radius: 6px;
  cursor: pointer;
  border: none;
  background: linear-gradient(90deg, #00eaff, #00b8ff);
  color: black;
  font-weight: bold;
  box-shadow: 0 0 15px #00eaff;
}

.modal-buttons button:last-child {
  background: rgba(255,255,255,0.2);
  color: #fff;
  box-shadow: none;
}

@keyframes fadeIn {
  from { opacity: 0 }
  to { opacity: 1 }
}

@keyframes popIn {
  from { transform: scale(.8); opacity:0 }
  to { transform: scale(1); opacity:1 }
}
  
</style>
</head>
<body>

<video id="camera" autoplay playsinline></video>
<div class="bi-border"></div>

<div class="ui-layer">
  <!-- 左 -->
  <div class="left-block">
    <select class="left-select" data-side="left">
      <option>BayBlade A</option>
      <option>BayBlade B</option>
      <option>BayBlade C</option>
    </select>
    <div class="frame-container left-frames">
      <div class="frame blue"></div>
      <div class="frame blue"></div>
      <div class="frame blue"></div>
      <div class="frame blue"></div>
    </div>
    <div class="score-container left-score-container">
      <div class="score" id="score-left">0</div>
      <div class="blader-name" contenteditable="true" id="left-blader">BLADER A</div>
    </div>
  </div>
  <!-- バトルカウント -->
  <div class="center-block">
    <div class="center-battle">Battle</div>
    <div class="center-rank" id="center-rank">1st</div>
  </div>
  <!-- 右 -->
  <div class="right-block">
    <select class="right-select" data-side="right">
      <option>BayBlade A</option>
      <option>BayBlade B</option>
      <option>BayBlade C</option>
    </select>
    <div class="frame-container right-frames">
      <div class="frame pink"></div>
      <div class="frame pink"></div>
      <div class="frame pink"></div>
      <div class="frame pink"></div>
    </div>
    <div class="score-container right-score-container">
      <div class="blader-name" contenteditable="true" id="right-blader">BLADER B</div>
      <div class="score" id="score-right">0</div>
    </div>
  </div>
</div>
<!-- デッキ編集モーダル -->
<div id="deckModal" class="modal-overlay" style="display:none;">
  <div id="deckModalContent" class="modal-content">
      <!-- デッキ編集UI -->
      <button id="saveDeckBtn" class="modal-save-btn">保存</button>
  </div>
</div>
  
<script>
// カメラ取得（任意）
navigator.mediaDevices?.getUserMedia?.({ video:{ facingMode:'environment' }, audio:false })
  .then(s => document.getElementById('camera').srcObject = s)
  .catch(e => console.warn('カメラ取得失敗:', e));


const leftBlock = document.querySelector('.left-block');
const rightBlock = document.querySelector('.right-block');
const centerRank = document.getElementById('center-rank');
const ranks = ["1st","2nd","3rd","4th","5th","6th","7th"];
let currentRankIndex = 0;
let rankCanAdvance = false;

// ランク表示を更新
function updateRank(){
  centerRank.textContent = ranks[currentRankIndex];
}

// タップで1つ進める
centerRank.addEventListener("click", () => {
  currentRankIndex = (currentRankIndex + 1) % ranks.length;
  updateRank();
});

// 長押しで1つ戻す
let pressTimer;
centerRank.addEventListener("mousedown", () => {
  pressTimer = setTimeout(() => {
    currentRankIndex = (currentRankIndex - 1 + ranks.length) % ranks.length;
    updateRank();
  }, 500); // 0.5秒以上押したら
});

centerRank.addEventListener("mouseup", () => clearTimeout(pressTimer));
centerRank.addEventListener("mouseleave", () => clearTimeout(pressTimer));

// スマホタッチ対応
centerRank.addEventListener("touchstart", () => {
  pressTimer = setTimeout(() => {
    currentRankIndex = (currentRankIndex - 1 + ranks.length) % ranks.length;
    updateRank();
  }, 500);
});

centerRank.addEventListener("touchend", () => clearTimeout(pressTimer));
centerRank.addEventListener("touchcancel", () => clearTimeout(pressTimer));

updateRank();

// HUD 追加/削除処理
function handleFrameTap(container, tappedFrame){
  const hudsInFrame = tappedFrame.querySelectorAll('.hud-ring');
  const frames = Array.from(container.querySelectorAll('.frame'));

  if(hudsInFrame.length > 0){
    // 全フレームからHUDを収集し、下→上で並べて一番下を消す
    const allHUDs = Array.from(container.querySelectorAll('.hud-ring'));
    const hudToRemove = allHUDs.sort((a,b)=>b.parentElement.offsetTop - a.parentElement.offsetTop)[0];
    hudToRemove.remove();
    updateScore(container);
    return;
  } else {
    // HUD 追加: 上の frame から順に1つだけ
    const nextFrame = frames.find(f => f.querySelectorAll('.hud-ring').length === 0);
    if(!nextFrame) return;

    const img = document.createElement('img');
    img.className = 'hud-ring';
    img.src = container.classList.contains('right-block') ? 'HudLing-pink.png' : 'HudLing.png';
    img.style.cssText = 'position:absolute;top:50%;left:50%;width:80px;height:80px;transform:translate(-50%, -50%);pointer-events:none;';
    nextFrame.appendChild(img);

    updateScore(container);

    rankCanAdvance = true;
  }
}
  
// スコア更新
function updateScore(container){
  const count = container.querySelectorAll('.hud-ring').length;
  const scoreEl = container.querySelector('.score');
  if(scoreEl) scoreEl.textContent = count;

  if(count === 4){
    const bladerNameEl = container.querySelector('.blader-name');
    const bladerName = bladerNameEl ? bladerNameEl.textContent : 'BLADER';
    showFinishEffect(bladerName);
  }
}

// 完了演出
function showFinishEffect(bladerName){
  const div = document.createElement('div');
  div.className = 'win-overlay';
  div.textContent = `${bladerName}\nWIN‼︎`;
  document.body.appendChild(div);
  setTimeout(()=>div.remove(), 2000);
}

// フレームタップ登録
[leftBlock, rightBlock].forEach(block=>{
  const frames = block.querySelectorAll('.frame');
  frames.forEach(frame=>{
    frame.addEventListener('click', e=>{
      e.stopPropagation();
      handleFrameTap(block, frame);
    });
  });
});

// 選択ボックス変更で rank 更新（HUD 増加直後のみ）
[leftBlock, rightBlock].forEach(block=>{
  const select = block.querySelector('select');
  select.addEventListener('change', ()=>{
    if(rankCanAdvance){
      currentRankIndex = (currentRankIndex + 1) % ranks.length;
      centerRank.textContent = ranks[currentRankIndex];
      rankCanAdvance = false;
    }
  });
});

// 初期スコア
updateScore(leftBlock);
updateScore(rightBlock);


const modal = document.getElementById("edit-modal");
const deckInputs = [document.getElementById("deck1"), document.getElementById("deck2"), document.getElementById("deck3")];

let currentDeckSelect = null; // 編集対象select

function openDeckEdit(select) {
  currentDeckSelect = select;

  const options = [...select.options].slice(0,3).map(o=>o.text);
  deckInputs.forEach((input, i)=> input.value = options[i] || "");

  modal.classList.remove("hidden");
}

document.getElementById("cancel-edit").onclick = () => {
  modal.classList.add("hidden");
};

document.getElementById("save-deck").onclick = () => {
  const newDecks = deckInputs.map(i=>i.value.trim() || "デッキ");

  // セレクト内容更新
  currentDeckSelect.innerHTML = `
    <option>${newDecks[0]}</option>
    <option>${newDecks[1]}</option>
    <option>${newDecks[2]}</option>
    <option>デッキ編集</option>
    <option>-</option>
  `;

  // 最初のデッキにセット
  currentDeckSelect.value = newDecks[0];

  modal.classList.add("hidden");

  // リセット適用
  resetBattleState();
};


function addDeckEditOption(select){
  const edit = document.createElement("option");
  edit.textContent = "デッキ編集";

  const dash = document.createElement("option");
  dash.textContent = "-";

  select.appendChild(edit);
  select.appendChild(dash);
}

function bladeSelectChanged(e){
  if(e.target.value === "デッキ編集"){
    openDeckEdit(e.target);
  } else if(e.target.value === "-"){
    // "-" 選択時 → 戻すだけ
    e.target.selectedIndex = 0;
  } else {
    // 通常デッキ切替 → リセット
    resetBattleState();
  }
}

function openDeckModal(side) {
  const modal = document.getElementById("deckModal");
  const modalContent = document.getElementById("deckModalContent");
  const saveBtn = document.getElementById("saveDeckBtn");

  modal.style.display = "flex";

  // 既存クラス削除
  modalContent.classList.remove("right");
  saveBtn.classList.remove("right");

  // ★ 右側選択時のみピンク化
  if (side === "right") {
    modalContent.classList.add("right");
    saveBtn.classList.add("right");
  }
}
  
  
// 初期化
document.querySelectorAll('.left-block select, .right-block select').forEach(select => {
  // 既存3つ保持 + 「デッキ編集」「-」付与
  const opts = [...select.options].slice(0,3).map(o=>o.textContent);
  
  select.innerHTML = "";
  opts.forEach(t=>{
    const opt = document.createElement("option");
    opt.textContent = t;
    select.appendChild(opt);
  });

  addDeckEditOption(select);
  
  select.addEventListener("change", bladeSelectChanged);
});

function saveDeckPresets(select){
  const side = select.dataset.side;
  const decks = Array.from(select.options).slice(0,-2).map(o => o.textContent);
  localStorage.setItem(`decks_${side}`, JSON.stringify(decks));
}

function loadDeckPresets(select){
  const side = select.dataset.side;
  const stored = JSON.parse(localStorage.getItem(`decks_${side}`) || "[]");
  if(stored.length > 0){
    // "-"と編集だけ残して全削除
    const reserved = Array.from(select.options).slice(-2);
    select.innerHTML = "";
    stored.forEach(t=>{
      const opt = document.createElement("option");
      opt.textContent = t;
      select.appendChild(opt);
    });
    reserved.forEach(o=>select.appendChild(o));
  }
}

</script>
</body>
</html>
